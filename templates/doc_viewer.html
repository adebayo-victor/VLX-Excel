<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>View Document</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='pdf_maker.css') }}">
  <style>
    :root{
      --accent:#2b6cb0;
      --bg:#fff;
      --muted:#6b7280;
      --success:#16a34a;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:20px;background:#f7fafc;color:#0f172a}
    .card{background:var(--bg);border-radius:8px;padding:18px;max-width:1100px;margin:0 auto;box-shadow:0 1px 3px rgba(15,23,42,0.06)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{font-weight:700}
    .controls{display:flex;gap:8px;align-items:center}
    a.btn, button {background:var(--accent);color:#fff;padding:8px 12px;border-radius:6px;text-decoration:none;border:none;cursor:pointer}
    a.ghost { background: transparent; color: var(--muted); border: 1px solid rgba(15,23,42,0.06); }
    .layout { display:flex; gap:16px; margin-top:14px; }
    .sidebar { width:280px; min-width:220px; max-height:72vh; overflow:auto; border-radius:8px; padding:12px; background:#fff; border:1px solid rgba(15,23,42,0.04)}
    .item { padding:10px; border-radius:6px; margin-bottom:8px; cursor:pointer; border:1px solid rgba(15,23,42,0.04) }
    .item.active { box-shadow:0 1px 0 rgba(15,23,42,0.03); border-color:rgba(43,108,176,0.12); background:#f8fafc }
    .viewer { flex:1; border-radius:8px; overflow:hidden; background:#fff; border:1px solid rgba(15,23,42,0.04) }
    iframe.pdf { width:100%; height:72vh; border:0; display:block; }
    .meta { font-size:.95rem; color:var(--muted); margin-top:8px }
    .small{ font-size:.9rem; color:#6b7280 }
    .empty { padding:24px; text-align:center; color:var(--muted) }
    .actions { display:flex; gap:8px; align-items:center; margin-bottom:10px }
    .badge { font-size:.8rem; padding:4px 8px; border-radius:999px; background:#eef2ff; color:var(--accent) }
  </style>
</head>
<body>
  <main class="card" id="root">
    <header>
      <div>
        <div class="title">Document Viewer</div>
        <div class="meta">View, open, or download generated templates for key: <strong>{{ templates[0].key if (templates and templates|length > 0) else 'N/A' }}</strong></div>
      </div>
      <div class="controls">
        <a class="btn ghost" href="{{ url_for('index') }}">Back</a>
        <a id="openBtn" class="btn hidden" href="#" target="_blank" rel="noopener">Open in new tab</a>
        <a id="downloadBtn" class="btn hidden" href="#" download>Download PDF</a>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar" id="sidebar">
        {% if templates and templates|length > 0 %}
          {% for t in templates %}
            <div class="item" data-index="{{ loop.index0 }}" data-subkey="{{ t.subkey }}" data-key="{{ t.key }}">
              <div><strong>Template #{{ loop.index }}</strong> <span class="badge">sub: {{ t.subkey }}</span></div>
              <div class="small" style="margin-top:6px; max-height:44px; overflow:hidden; color:#334155;">
                {{ (t.template[:240] ~ '...') if (t.template|length > 240) else t.template }}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty">No templates found for this key.</div>
        {% endif %}
      </aside>

      <section class="viewer" id="viewerWrap" aria-live="polite">
        {% if templates and templates|length > 0 %}
          {# We'll render the first template immediately using srcdoc for safe embedding. JS will manage switching #}
          <iframe class="pdf" id="pdfFrame" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
        {% else %}
          <div class="empty">No document to preview.</div>
        {% endif %}
      </section>
    </div>

    <div class="meta" id="msg" style="margin-top:12px"></div>
  </main>

  <script>
    (function(){
      // Acquire templates from server-rendered context (safe via tojson)
      const templates = {{ templates|tojson }};
      const sidebar = document.getElementById('sidebar');
      const pdfFrame = document.getElementById('pdfFrame');
      const openBtn = document.getElementById('openBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const msg = document.getElementById('msg');

      if (!templates || templates.length === 0) {
        // nothing to do
        return;
      }

      // Normalize template content (strip triple backticks that the backend may have inserted)
      templates.forEach(t => {
        if (typeof t.template === 'string') {
          t.template = t.template.replace(/```/g, '');
        } else {
          t.template = String(t.template || '');
        }
        // Ensure subkey and key exist for download route
        t.subkey = (typeof t.subkey !== 'undefined') ? t.subkey : 0;
        t.key = t.key || (templates.length && templates[0].key) || '';
      });

      let currentIndex = 0;

      function renderTemplateAt(index) {
        const t = templates[index];
        if (!t) return;
        currentIndex = index;

        // Use srcdoc to embed the HTML string - cleaner than injecting innerHTML.
        try {
          // Some browsers limit srcdoc length; as fallback, create blob URL
          const html = t.template;
          const supportsSrcdoc = 'srcdoc' in document.createElement('iframe');
          if (supportsSrcdoc) {
            pdfFrame.srcdoc = html;
          } else {
            // Fallback: create blob URL
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            pdfFrame.src = url;
            // revoke old blob later (keep reference)
            if (pdfFrame._currentBlob) {
              URL.revokeObjectURL(pdfFrame._currentBlob);
            }
            pdfFrame._currentBlob = url;
          }

          // Update controls
          openBtn.href = '#';
          openBtn.classList.remove('hidden');
          downloadBtn.href = `/download_doc/${encodeURIComponent(t.key)}/${encodeURIComponent(t.subkey)}`;
          downloadBtn.classList.remove('hidden');

          msg.textContent = `Showing template ${index + 1} (subkey: ${t.subkey}) â€” Created under key ${t.key}`;
        } catch (err) {
          console.error('Error rendering template', err);
          msg.textContent = 'Failed to render template preview.';
        }

        // Mark active item in sidebar
        const items = sidebar.querySelectorAll('.item');
        items.forEach(it => it.classList.remove('active'));
        const active = sidebar.querySelector('.item[data-index="'+index+'"]');
        if (active) active.classList.add('active');
      }

      // Sidebar click handling
      sidebar.addEventListener('click', (e) => {
        const item = e.target.closest('.item');
        if (!item) return;
        const idx = Number(item.getAttribute('data-index'));
        if (!Number.isNaN(idx)) {
          renderTemplateAt(idx);
        }
      });

      // Open in new tab: create a blob of the current HTML and open in new window
      openBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const t = templates[currentIndex];
        if (!t) return;
        const blob = new Blob([t.template], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank', 'noopener');
        // Revoke after a short delay to allow the new tab to load
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      });

      // Setup initial render (first template)
      renderTemplateAt(0);

      // Accessibility: allow arrow keys to navigate templates
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === 'j') {
          const next = Math.min(templates.length - 1, currentIndex + 1);
          renderTemplateAt(next);
        } else if (e.key === 'ArrowUp' || e.key === 'k') {
          const prev = Math.max(0, currentIndex - 1);
          renderTemplateAt(prev);
        } else if ((e.key === 'o' || e.key === 'O') && templates[currentIndex]) {
          // open
          const t = templates[currentIndex];
          const blob = new Blob([t.template], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank', 'noopener');
          setTimeout(() => URL.revokeObjectURL(url), 2000);
        }
      });
    })();
  </script>
</body>
</html>