<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>View Document</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='pdf_maker.css') }}">
  <style>
    :root{ --accent:#2b6cb0; --muted:#6b7280; --bg:#fff }

    /* Base page */
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      margin:12px;
      background:#f7fafc;
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.35;
    }

    .card{
      background:var(--bg);
      border-radius:8px;
      padding:14px;
      max-width:1200px;
      margin:0 auto;
      box-shadow:0 1px 3px rgba(15,23,42,0.06);
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .title{font-weight:700}
    .meta { font-size:.95rem; color:var(--muted) }

    .controls { display:flex; gap:8px; align-items:center; }

    a.btn, button { background:var(--accent); color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; border:none; cursor:pointer }
    a.ghost { background: transparent; color: var(--muted); border: 1px solid rgba(15,23,42,0.06); padding:7px 10px; border-radius:6px }

    /* Layout */
    .layout { display:flex; gap:16px; }
    .sidebar {
      width:300px;
      min-width:200px;
      max-height:72vh;
      overflow:auto;
      border-radius:8px;
      padding:12px;
      background:#fff;
      border:1px solid rgba(15,23,42,0.04);
      box-sizing:border-box;
      transition:transform .18s ease, opacity .18s ease;
    }
    .sidebar.collapsed { display:none; } /* used for mobile toggle */

    .item {
      padding:10px;
      border-radius:6px;
      margin-bottom:8px;
      cursor:pointer;
      border:1px solid rgba(15,23,42,0.04);
      user-select:none;
      background:#fff;
    }
    .item.active { background:#f8fafc; border-color:rgba(43,108,176,0.12); box-shadow: inset 0 0 0 1px rgba(43,108,176,0.02); }

    .viewer {
      flex:1;
      border-radius:8px;
      overflow:hidden;
      background:#fff;
      border:1px solid rgba(15,23,42,0.04);
      min-height:60vh;
      display:flex;
      flex-direction:column;
    }

    /* Make iframe fill the viewer area responsibly */
    iframe.pdf {
      width:100%;
      height:calc(100vh - 230px); /* fallback desktop height */
      border:0;
      display:block;
    }

    /* Small metadata/controls inside viewer */
    .viewer-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(15,23,42,0.04);
      background: #fbfdff;
    }
    .viewer-actions { display:flex; gap:8px; align-items:center; }

    .small { font-size:.9rem; color:#6b7280 }
    .empty { padding:24px; text-align:center; color:var(--muted) }

    /* Hide script templates visually */
    script[type="text/template"]{display:none;}

    /* Responsive behaviour */
    @media (max-width: 900px) {
      .layout { flex-direction:column; gap:10px; }
      .sidebar {
        width:100%;
        max-height:36vh;
      }
      .sidebar.collapsed { display:none; } /* hide by default if collapsed */
      iframe.pdf { height:calc(100vh - 280px); }
      .card{padding:10px}
    }

    @media (max-width: 520px) {
      header { flex-direction:column; align-items:flex-start; gap:8px; }
      .controls { width:100%; justify-content:space-between; }
      .viewer-head { padding:8px; }
      iframe.pdf { height:calc(100vh - 320px); }
    }
  </style>
</head>
<body>
  <main class="card" id="root">
    <header>
      <div>
        <div class="title">Document Viewer</div>
        <div class="meta">Templates for key: <strong>{{ templates[0].key if (templates and templates|length > 0) else 'N/A' }}</strong></div>
      </div>

      <div class="controls">
        <a class="btn ghost" href="{{ url_for('index') }}">Back</a>
        <button id="toggleSidebarBtn" class="btn ghost" title="Show / hide templates list">Templates</button>
        <a id="openBtn" class="btn hidden" href="#" target="_blank" rel="noopener">Open</a>
        <a id="downloadBtn" class="btn hidden" href="#" download>Download</a>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar" id="sidebar" aria-label="Templates list">
        {% if templates and templates|length > 0 %}
          {% for t in templates %}
            <div class="item" data-index="{{ loop.index0 }}" data-subkey="{{ t.subkey }}" data-key="{{ t.key }}" title="Click to preview">
              <div><strong>Template #{{ loop.index }}</strong> <span class="small" style="margin-left:8px;color:var(--muted)">sub: {{ t.subkey }}</span></div>
              <div class="small" style="margin-top:6px; color:#334155;">
                {{ t.key }} — preview available
              </div>
            </div>

            {# Hidden, escaped raw template for JS #}
            <script type="text/template" id="tpl-{{ loop.index0 }}">{{ t.template | replace('```', '') | e }}</script>
          {% endfor %}
        {% else %}
          <div class="empty">No templates found for this key.</div>
        {% endif %}
      </aside>

      <section class="viewer" id="viewerWrap" aria-live="polite">
        <div class="viewer-head">
          <div class="small" id="viewerInfo">No template selected</div>
          <div class="viewer-actions">
            <a id="openInTab" class="btn ghost hidden" href="#" target="_blank" rel="noopener">Open in new tab</a>
            <a id="downloadPdf" class="btn ghost hidden" href="#" download>Download PDF</a>
          </div>
        </div>

        {% if templates and templates|length > 0 %}
          <iframe class="pdf" id="pdfFrame" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
        {% else %}
          <div class="empty">No document to preview.</div>
        {% endif %}
      </section>
    </div>

    <div class="meta" id="msg" style="margin-top:12px"></div>
  </main>

  <script>
    (function(){
      // DOM refs
      const sidebar = document.getElementById('sidebar');
      const pdfFrame = document.getElementById('pdfFrame');
      const openBtn = document.getElementById('openBtn'); // kept for compatibility
      const downloadBtn = document.getElementById('downloadBtn'); // kept for compatibility
      const viewerInfo = document.getElementById('viewerInfo');
      const openInTab = document.getElementById('openInTab');
      const downloadPdf = document.getElementById('downloadPdf');
      const msg = document.getElementById('msg');
      const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');

      // Collect script templates
      const scriptTemplates = document.querySelectorAll('script[type="text/template"]');
      if (!scriptTemplates || scriptTemplates.length === 0) {
        msg.textContent = 'No templates available to preview.';
        return;
      }

      const templates = Array.from(scriptTemplates).map((s, idx) => {
        const prev = s.previousElementSibling;
        return {
          templateRaw: s.innerHTML || '',
          index: idx,
          key: prev ? prev.getAttribute('data-key') : '',
          subkey: prev ? prev.getAttribute('data-subkey') : idx
        };
      });

      function htmlDecode(input) {
        const txt = document.createElement('textarea');
        txt.innerHTML = input;
        return txt.value;
      }
      templates.forEach(t => t.template = htmlDecode(t.templateRaw || ''));

      let currentIndex = 0;

      function renderTemplateAt(index) {
        const t = templates[index];
        if (!t) return;
        currentIndex = index;

        try {
          if ('srcdoc' in pdfFrame) {
            pdfFrame.srcdoc = t.template;
          } else {
            if (pdfFrame._currentBlob) {
              URL.revokeObjectURL(pdfFrame._currentBlob);
              pdfFrame._currentBlob = null;
            }
            const blob = new Blob([t.template], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            pdfFrame.src = url;
            pdfFrame._currentBlob = url;
          }

          // Update controls & info
          openBtn.classList.remove('hidden');
          downloadBtn.classList.remove('hidden');
          openBtn.href = '#';
          downloadBtn.href = `/download_doc/${encodeURIComponent(t.key)}/${encodeURIComponent(t.subkey)}`;

          openInTab.classList.remove('hidden');
          downloadPdf.classList.remove('hidden');
          openInTab.href = '#';
          downloadPdf.href = `/download_doc/${encodeURIComponent(t.key)}/${encodeURIComponent(t.subkey)}`;

          viewerInfo.textContent = `Showing template ${index + 1} (subkey: ${t.subkey}) — Key: ${t.key}`;
          msg.textContent = '';

          // If on small screen, hide sidebar to maximize viewer space
          if (window.matchMedia && window.matchMedia('(max-width:900px)').matches) {
            sidebar.classList.add('collapsed');
          }
        } catch (err) {
          console.error('Error rendering template', err);
          msg.textContent = 'Failed to render template preview: ' + (err.message || err);
        }

        // Highlight active item
        const items = sidebar.querySelectorAll('.item');
        items.forEach(it => it.classList.remove('active'));
        const active = sidebar.querySelector('.item[data-index="'+index+'"]');
        if (active) active.classList.add('active');
      }

      // Sidebar click handling
      sidebar.addEventListener('click', (e) => {
        const item = e.target.closest('.item');
        if (!item) return;
        const idx = Number(item.getAttribute('data-index'));
        if (!Number.isNaN(idx)) {
          renderTemplateAt(idx);
        }
      });

      // Open in new tab (creates a blob url)
      openInTab.addEventListener('click', (e) => {
        e.preventDefault();
        const t = templates[currentIndex];
        if (!t) return;
        const blob = new Blob([t.template], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank', 'noopener');
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      });

      // Toggle sidebar visibility (mobile)
      toggleSidebarBtn.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        // move focus to first item when opening
        if (!sidebar.classList.contains('collapsed')) {
          const firstItem = sidebar.querySelector('.item');
          if (firstItem) firstItem.focus();
        }
      });

      // Close sidebar if clicked outside on small screens (nice UX)
      document.addEventListener('click', (e) => {
        if (window.matchMedia && window.matchMedia('(max-width:900px)').matches) {
          const isInside = e.target.closest('#sidebar') || e.target.closest('#toggleSidebarBtn');
          if (!isInside) sidebar.classList.add('collapsed');
        }
      });

      // Initial render to first template
      renderTemplateAt(0);

      // Keyboard nav (optional)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === 'j') {
          const next = Math.min(templates.length - 1, currentIndex + 1);
          renderTemplateAt(next);
        } else if (e.key === 'ArrowUp' || e.key === 'k') {
          const prev = Math.max(0, currentIndex - 1);
          renderTemplateAt(prev);
        } else if ((e.key === 'o' || e.key === 'O') && templates[currentIndex]) {
          const t = templates[currentIndex];
          const blob = new Blob([t.template], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank', 'noopener');
          setTimeout(() => URL.revokeObjectURL(url), 2000);
        }
      });

      // Cleanup blob URLs when unloading
      window.addEventListener('beforeunload', () => {
        if (pdfFrame._currentBlob) URL.revokeObjectURL(pdfFrame._currentBlob);
      });
    })();
  </script>
</body>
</html>