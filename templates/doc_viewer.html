<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>View Document</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='pdf_maker.css') }}">
  <style>
    :root{ --accent:#2b6cb0; --muted:#6b7280; --bg:#fff }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:20px;background:#f7fafc;color:#0f172a}
    .card{background:var(--bg);border-radius:8px;padding:18px;max-width:1100px;margin:0 auto;box-shadow:0 1px 3px rgba(15,23,42,0.06)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{font-weight:700}
    .controls{display:flex;gap:8px;align-items:center}
    a.btn, button {background:var(--accent);color:#fff;padding:8px 12px;border-radius:6px;text-decoration:none;border:none;cursor:pointer}
    a.ghost { background: transparent; color: var(--muted); border: 1px solid rgba(15,23,42,0.06); }
    .layout { display:flex; gap:16px; margin-top:14px; }
    .sidebar { width:300px; min-width:220px; max-height:72vh; overflow:auto; border-radius:8px; padding:12px; background:#fff; border:1px solid rgba(15,23,42,0.04)}
    .item { padding:10px; border-radius:6px; margin-bottom:8px; cursor:pointer; border:1px solid rgba(15,23,42,0.04); user-select:none; }
    .item.active { box-shadow:0 1px 0 rgba(15,23,42,0.03); border-color:rgba(43,108,176,0.12); background:#f8fafc }
    .viewer { flex:1; border-radius:8px; overflow:hidden; background:#fff; border:1px solid rgba(15,23,42,0.04) }
    iframe.pdf { width:100%; height:72vh; border:0; display:block; }
    .meta { font-size:.95rem; color:var(--muted); margin-top:8px }
    .small{ font-size:.9rem; color:#6b7280 }
    .empty { padding:24px; text-align:center; color:var(--muted) }
    .actions { display:flex; gap:8px; align-items:center; margin-bottom:10px }
    .badge { font-size:.8rem; padding:4px 8px; border-radius:999px; background:#eef2ff; color:var(--accent) }
    /* Keep script templates hidden and non-rendering */
    script[type="text/template"] { display:none; }
  </style>
</head>
<body>
  <main class="card" id="root">
    <header>
      <div>
        <div class="title">Document Viewer</div>
        <div class="meta">Templates for key: <strong>{{ templates[0].key if (templates and templates|length > 0) else 'N/A' }}</strong></div>
      </div>
      <div class="controls">
        <a class="btn ghost" href="{{ url_for('index') }}">Back</a>
        <a id="openBtn" class="btn hidden" href="#" target="_blank" rel="noopener">Open in new tab</a>
        <a id="downloadBtn" class="btn hidden" href="#" download>Download PDF</a>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar" id="sidebar">
        {% if templates and templates|length > 0 %}
          {% for t in templates %}
            <div class="item" data-index="{{ loop.index0 }}" data-subkey="{{ t.subkey }}" data-key="{{ t.key }}" title="Click to preview">
              <div><strong>Template #{{ loop.index }}</strong> <span class="badge">sub: {{ t.subkey }}</span></div>
              <div class="small" style="margin-top:6px; color:#334155;">
                <!-- Deliberately do not show raw HTML content here.
                     Keep only minimal, safe metadata in the sidebar. -->
                {{ t.key }} — preview available
              </div>
            </div>

            {# Keep raw template HTML inside a hidden script tag (escaped) so JS can read it,
               but do NOT render any snippet in the sidebar. #}
            <script type="text/template" id="tpl-{{ loop.index0 }}">{{ t.template | replace('```', '') | e }}</script>
          {% endfor %}
        {% else %}
          <div class="empty">No templates found for this key.</div>
        {% endif %}
      </aside>

      <section class="viewer" id="viewerWrap" aria-live="polite">
        {% if templates and templates|length > 0 %}
          {# Render the selected template inside an iframe (srcdoc or blob) #}
          <iframe class="pdf" id="pdfFrame" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
        {% else %}
          <div class="empty">No document to preview.</div>
        {% endif %}
      </section>
    </div>

    <div class="meta" id="msg" style="margin-top:12px"></div>
  </main>

  <script>
    (function(){
      // DOM refs
      const sidebar = document.getElementById('sidebar');
      const pdfFrame = document.getElementById('pdfFrame');
      const openBtn = document.getElementById('openBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const msg = document.getElementById('msg');

      // Gather templates from the hidden <script type="text/template"> tags
      const scriptTemplates = document.querySelectorAll('script[type="text/template"]');
      if (!scriptTemplates || scriptTemplates.length === 0) {
        msg.textContent = 'No templates available to preview.';
        return;
      }

      const templates = Array.from(scriptTemplates).map((s, idx) => {
        // s.innerHTML contains escaped HTML (Jinja |e), decode safely below
        const prev = s.previousElementSibling;
        return {
          templateRaw: s.innerHTML || '',
          index: idx,
          key: prev ? prev.getAttribute('data-key') : '',
          subkey: prev ? prev.getAttribute('data-subkey') : idx
        };
      });

      // decode HTML entities that Jinja escaped (safe)
      function htmlDecode(input) {
        const txt = document.createElement('textarea');
        txt.innerHTML = input;
        return txt.value;
      }

      templates.forEach(t => {
        t.template = htmlDecode(t.templateRaw || '');
      });

      let currentIndex = 0;

      function renderTemplateAt(index) {
        const t = templates[index];
        if (!t) return;
        currentIndex = index;

        try {
          // Use srcdoc where available for direct HTML preview
          if ('srcdoc' in pdfFrame) {
            pdfFrame.srcdoc = t.template;
          } else {
            // fallback to blob URL
            if (pdfFrame._currentBlob) {
              URL.revokeObjectURL(pdfFrame._currentBlob);
              pdfFrame._currentBlob = null;
            }
            const blob = new Blob([t.template], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            pdfFrame.src = url;
            pdfFrame._currentBlob = url;
          }

          // Update controls
          openBtn.classList.remove('hidden');
          downloadBtn.classList.remove('hidden');
          openBtn.href = '#';
          downloadBtn.href = `/download_doc/${encodeURIComponent(t.key)}/${encodeURIComponent(t.subkey)}`;
          msg.textContent = `Showing template ${index + 1} (subkey: ${t.subkey}) — Key: ${t.key}`;
        } catch (err) {
          console.error('Error rendering template', err);
          msg.textContent = 'Failed to render template preview: ' + (err.message || err);
        }

        // highlight active item
        const items = sidebar.querySelectorAll('.item');
        items.forEach(it => it.classList.remove('active'));
        const active = sidebar.querySelector('.item[data-index="'+index+'"]');
        if (active) active.classList.add('active');
      }

      // click handling
      sidebar.addEventListener('click', (e) => {
        const item = e.target.closest('.item');
        if (!item) return;
        const idx = Number(item.getAttribute('data-index'));
        if (!Number.isNaN(idx)) {
          renderTemplateAt(idx);
        }
      });

      // open in new tab
      openBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const t = templates[currentIndex];
        if (!t) return;
        const blob = new Blob([t.template], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank', 'noopener');
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      });

      // initial render
      renderTemplateAt(0);

      // keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === 'j') {
          const next = Math.min(templates.length - 1, currentIndex + 1);
          renderTemplateAt(next);
        } else if (e.key === 'ArrowUp' || e.key === 'k') {
          const prev = Math.max(0, currentIndex - 1);
          renderTemplateAt(prev);
        } else if ((e.key === 'o' || e.key === 'O') && templates[currentIndex]) {
          const t = templates[currentIndex];
          const blob = new Blob([t.template], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank', 'noopener');
          setTimeout(() => URL.revokeObjectURL(url), 2000);
        }
      });
    })();
  </script>
</body>
</html>