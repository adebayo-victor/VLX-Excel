<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF Maker</title>
  <style>
    :root{
      --accent:#2b6cb0;
      --bg: #fff;
      --muted:#6b7280;
      --success:#16a34a;
      --danger:#ef4444;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:24px;background:#f7fafc;color:#0f172a}
    .card{background:var(--bg);border-radius:8px;box-shadow:0 1px 3px rgba(15,23,42,0.06);padding:20px;max-width:720px;margin:0 auto}
    .controls{display:flex;gap:12px;align-items:center}
    button, a.btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;text-decoration:none;display:inline-flex;gap:8px;align-items:center}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:0.95rem}
    .overlay{display:flex;gap:12px;align-items:center;padding:12px;margin-top:12px;border-radius:8px;background:#f1f5f9;border:1px solid rgba(15,23,42,0.04)}
    .overlay.clickable{cursor:pointer}
    .hidden{display:none}
    /* spinner */
    .spinner{
      width:42px;height:42px;border-radius:50%;border:4px solid rgba(59,130,246,0.14);box-sizing:border-box;position:relative;
      display:inline-block;
    }
    .spinner::after{
      content:"";position:absolute;inset:4px;border-radius:50%;border:4px solid transparent;border-top-color:var(--accent);animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .status-text{font-weight:600}
    .small{font-size:.9rem;color:var(--muted)}
    .result-success{display:flex;gap:12px;align-items:center;margin-top:12px}
    .result-success .ok{color:var(--success);font-weight:700}
    .error{color:var(--danger);font-weight:600;margin-top:12px}
  </style>
</head>
<body>
  <main class="card">
    <h2>Generate PDF</h2>
    <p class="muted">Click “Generate PDF” to request the server. When the server returns a successful URL, you'll get a button to open it.</p>

    <!-- Example: change data-endpoint to your server route -->
    <div class="controls">
      <button id="generateBtn" data-endpoint="/make_pdf">Generate PDF</button>
      <div id="spinnerWrap" class="overlay hidden" role="status" aria-live="polite" title="Processing document">
        <div class="spinner" id="spinner" aria-hidden="true"></div>
        <div>
          <div class="status-text" id="processingText">Processing document…</div>
          <div class="small" id="processingSub">This may take a few seconds.</div>
        </div>
      </div>
    </div>

    <div id="result" class="result-success hidden">
      <span class="ok" id="okText">Document ready</span>
      <a id="openBtn" class="btn" href="#" target="_blank" rel="noopener">Open document</a>
    </div>

    <div id="errorMsg" class="error hidden" role="alert"></div>
  </main>

  <script>
    (function(){
      const generateBtn = document.getElementById('generateBtn');
      const spinnerWrap = document.getElementById('spinnerWrap');
      const processingText = document.getElementById('processingText');
      const processingSub = document.getElementById('processingSub');
      const result = document.getElementById('result');
      const openBtn = document.getElementById('openBtn');
      const errorMsg = document.getElementById('errorMsg');

      // Holds the URL returned by the server once ready
      let returnedUrl = "";

      // Helper to show/hide
      function show(el){ el.classList.remove('hidden') }
      function hide(el){ el.classList.add('hidden') }

      // Click on spinner/overlay: if url exists open it; otherwise notify user it's still processing
      spinnerWrap.addEventListener('click', (e) => {
        if (returnedUrl) {
          window.open(returnedUrl, '_blank', 'noopener');
        } else {
          // brief highlight to notify not ready
          processingText.textContent = 'Still processing — please wait…';
          setTimeout(() => processingText.textContent = 'Processing document…', 1600);
        }
      });

      // Main click handler to make request
      generateBtn.addEventListener('click', async function (e) {
        const endpoint = generateBtn.getAttribute('data-endpoint') || '/make_pdf';

        // UI: start processing
        generateBtn.disabled = true;
        hide(result);
        hide(errorMsg);
        returnedUrl = "";
        processingText.textContent = 'Processing document…';
        processingSub.textContent = 'This may take a few seconds.';
        spinnerWrap.classList.add('clickable');
        show(spinnerWrap);

        try {
          // Example POST — if you need different payload, update here.
          const payload = {
            // If your template has form data, collect it and include it here
            // For example: document.getElementById('myInput').value
          };

          const resp = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              // Add auth or CSRF headers here if needed
            },
            body: JSON.stringify(payload)
          });

          if (!resp.ok) {
            throw new Error('Server returned ' + resp.status);
          }

          const data = await resp.json();

          // Expected format: {"response":"successful","url":"https://..."}
          if (data && (data.response === 'successful' || data.status === 'ok') && data.url) {
            returnedUrl = data.url;

            // Update UI to show result button
            openBtn.href = returnedUrl;
            openBtn.textContent = 'Open document';
            show(result);

            // Turn spinner into success message
            processingText.textContent = 'Document ready — click Open document or the animation';
            processingSub.textContent = '';
            // Keep overlay visible but no longer clickable would be fine; we keep clickable to open the url.
            // Optionally, remove spinner animation:
            spinnerWrap.querySelector('.spinner').style.borderColor = 'rgba(34,197,94,0.15)';
            spinnerWrap.querySelector('.spinner').style.boxShadow = '0 0 0 3px rgba(34,197,94,0.06)';

            // Re-enable the generate button in case user wants to run again
            generateBtn.disabled = false;
          } else {
            // Unexpected response object
            throw new Error('Unexpected response from server: ' + JSON.stringify(data));
          }
        } catch (err) {
          console.error(err);
          errorMsg.textContent = 'Could not generate document: ' + (err.message || err);
          show(errorMsg);
          generateBtn.disabled = false;
          hide(result);
        } finally {
          // Keep overlay visible while ready so user can click it; if there was an error hide overlay.
          if (!returnedUrl) {
            hide(spinnerWrap);
          }
        }
      });
    })();
  </script>
</body>
</html>